on:
  push:
    tags:
      - "v*"

name: Create release and build artifacts

jobs:
  build_win_msvc:
    name: Build Windows (MSVC) artifacts
    runs-on: windows-2025
    steps:
      - name: Checkout code
        uses: actions/checkout@master
      - name: Checkout deps
        run: git clone https://github.com/xmrig/xmrig-deps.git
      - name: Build project on Windows (MSVC)
        run: |
          mkdir build
          cd build
          cmake .. -G "Visual Studio 17 2022" -A x64 -DXMRIG_DEPS=${{ github.workspace }}/xmrig-deps/msvc2022/x64
          cmake --build . --config Release
          cd ..
      - name: Package Windows MSVC build
        run: |
          Copy-Item build\Release\xmrig.exe -Destination .
          Copy-Item src\config.json -Destination .
          Copy-Item bin\WinRing0\WinRing0x64.sys -Destination .
          Compress-Archive -Path xmrig.exe, config.json, WinRing0x64.sys -DestinationPath windows_build_msvc.zip
      - name: Upload Windows MSVC build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows_build_msvc
          path: windows_build_msvc.zip

  build_win_gcc:
    name: Build Windows (GCC) artifacts
    runs-on: windows-2025
    defaults:
      run:
        shell: msys2 {0}
    steps:
      - name: Setup MSYS2 + UCRT64
        uses: msys2/setup-msys2@v2
        with:
          msystem: UCRT64 # selects the UCRT64 environment
          update: true
          install: >
            base-devel
            mingw-w64-ucrt-x86_64-toolchain
            mingw-w64-ucrt-x86_64-7zip
            cmake
            git
      - name: Checkout code
        uses: actions/checkout@master
      - name: Checkout deps
        run: git clone https://github.com/xmrig/xmrig-deps.git
      - name: Build project on Windows (GCC)
        run: |
          cmake . -G "Unix Makefiles" -DXMRIG_DEPS=./xmrig-deps/gcc/x64
          make -j2
          cp ./src/config.json .
          cp ./bin/WinRing0/WinRing0x64.sys .
          7z a -tzip -mx windows_build_gcc.zip xmrig.exe config.json WinRing0x64.sys
      - name: Upload Windows GCC build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows_build_gcc
          path: windows_build_gcc.zip

  # --- Linux x64: static (Ubuntu 12, max compatibility) ---
  build_linux_x64_static:
    name: Build Linux x64 (static)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@master
      - name: Run build inside docker (Ubuntu 12.04)
        run: |
          mkdir -p /tmp/docker
          cat >/tmp/docker/script.sh <<'SCRIPT'
          set -x
          sed -i -r 's/(archive|security).ubuntu.com/old-releases.ubuntu.com/g' /etc/apt/sources.list
          apt-get update
          apt-get install -y python-software-properties
          add-apt-repository -y ppa:ubuntu-toolchain-r/test
          apt-get update
          apt-get install -y git build-essential automake libtool autoconf wget libgmp-dev libmpfr-dev texinfo bison flex gcc-9 g++-9 curl
          update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-9 60 --slave /usr/bin/g++ g++ /usr/bin/g++-9
          curl -sSL https://cmake.org/files/v3.27/cmake-3.27.9-linux-x86_64.tar.gz | tar -xzC /opt
          git clone --depth 1 git://sourceware.org/git/binutils-gdb.git /tmp/binutils-gdb
          (cd /tmp/binutils-gdb && git checkout binutils-2_38 && CC=gcc ./configure && make -j$(nproc) && make install)

          cd /workspace
          (cd scripts && ./build_deps.sh && cd ..)
          /opt/cmake-3.27.9-linux-x86_64/bin/cmake . -DXMRIG_DEPS=scripts/deps
          make -j$(nproc)
          cp src/config.json .
          tar cfz /workspace/linux_x64_static.tar.gz xmrig config.json
          SCRIPT
          chmod +x /tmp/docker/script.sh
          docker run --rm -i -v /tmp/docker:/tmp/docker -v "${{ github.workspace }}":/workspace ubuntu:12.04 /bin/bash /tmp/docker/script.sh
      - name: Upload Linux x64 static build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux_x64_static
          path: linux_x64_static.tar.gz

  # --- Linux x64: dynamic (Ubuntu 24.04 noble) ---
  build_linux_x64_ubuntu2404_noble:
    name: Build Linux x64 (Ubuntu 24.04 noble, dynamic)
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout code
        uses: actions/checkout@master
      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y git build-essential cmake libuv1-dev libssl-dev libhwloc-dev
      - name: Build
        run: |
          cmake .
          make -j$(nproc)
          cp src/config.json .
          tar cfz linux_x64_ubuntu24.04_noble.tar.gz xmrig config.json
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux_x64_ubuntu24.04_noble
          path: linux_x64_ubuntu24.04_noble.tar.gz

  # --- Linux x64: dynamic (Ubuntu 22.04 jammy) ---
  build_linux_x64_ubuntu2204_jammy:
    name: Build Linux x64 (Ubuntu 22.04 jammy, dynamic)
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@master
      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y git build-essential cmake libuv1-dev libssl-dev libhwloc-dev
      - name: Build
        run: |
          cmake .
          make -j$(nproc)
          cp src/config.json .
          tar cfz linux_x64_ubuntu22.04_jammy.tar.gz xmrig config.json
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux_x64_ubuntu22.04_jammy
          path: linux_x64_ubuntu22.04_jammy.tar.gz

  # --- Linux ARM64: static (Ubuntu 20) ---
  build_linux_arm64_static:
    name: Build Linux ARM64 (static)
    runs-on: ubuntu-latest
    steps:
      - name: Set up QEMU for ARM64
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64
      - name: Checkout code
        uses: actions/checkout@master
      - name: Build inside ARM64 Docker (Ubuntu 20.04, static deps)
        run: |
          docker run --rm --platform linux/arm64 \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            ubuntu:20.04 /bin/bash -c "
              set -e
              apt-get update
              apt-get install -y git build-essential cmake wget autoconf automake libtool perl
              (cd scripts && ./build_deps.sh && cd ..)
              cmake . -DXMRIG_DEPS=scripts/deps
              make -j\$(nproc)
              cp src/config.json .
              tar cfz linux_arm64_static.tar.gz xmrig config.json
            "
      - name: Upload Linux ARM64 static build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux_arm64_static
          path: linux_arm64_static.tar.gz

  # --- Linux ARM64: dynamic (Ubuntu 24.04 noble) ---
  build_linux_arm64_ubuntu2404_noble:
    name: Build Linux ARM64 (Ubuntu 24.04 noble, dynamic)
    runs-on: ubuntu-latest
    steps:
      - name: Set up QEMU for ARM64
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64
      - name: Checkout code
        uses: actions/checkout@master
      - name: Build inside ARM64 Docker (Ubuntu 24.04)
        run: |
          docker run --rm --platform linux/arm64 \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            ubuntu:24.04 /bin/bash -c "
              set -e
              apt-get update
              apt-get install -y git build-essential cmake libuv1-dev libssl-dev libhwloc-dev
              cmake .
              make -j\$(nproc)
              cp src/config.json .
              tar cfz linux_arm64_ubuntu24.04_noble.tar.gz xmrig config.json
            "
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux_arm64_ubuntu2404_noble
          path: linux_arm64_ubuntu24.04_noble.tar.gz

  # --- Linux ARM64: dynamic (Ubuntu 22.04 jammy) ---
  build_linux_arm64_ubuntu2204_jammy:
    name: Build Linux ARM64 (Ubuntu 22.04 jammy, dynamic)
    runs-on: ubuntu-latest
    steps:
      - name: Set up QEMU for ARM64
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64
      - name: Checkout code
        uses: actions/checkout@master
      - name: Build inside ARM64 Docker (Ubuntu 22.04)
        run: |
          docker run --rm --platform linux/arm64 \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            ubuntu:22.04 /bin/bash -c "
              set -e
              apt-get update
              apt-get install -y git build-essential cmake libuv1-dev libssl-dev libhwloc-dev
              cmake .
              make -j\$(nproc)
              cp src/config.json .
              tar cfz linux_arm64_ubuntu22.04_jammy.tar.gz xmrig config.json
            "
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux_arm64_ubuntu22.04_jammy
          path: linux_arm64_ubuntu22.04_jammy.tar.gz

  build_macos:
    name: Build MacOS artifacts
    runs-on: macos-latest
    steps:
      - name: Prepare MacOS tools
        run: |
          brew install cmake libuv openssl hwloc
      - name: Checkout code
        uses: actions/checkout@master
      - name: Build hwloc on MacOS
        run: |
          curl -O https://download.open-mpi.org/release/hwloc/v2.1/hwloc-2.1.0.tar.bz2
          tar xjf hwloc-2.1.0.tar.bz2
          cd hwloc-2.1.0
          ./configure --disable-shared --enable-static --disable-io --disable-libxml2
          make -j$(sysctl -n hw.logicalcpu)
          cd ..
      - name: Build project on MacOS
        run: |
          cmake . -DOPENSSL_ROOT_DIR=/usr/local/opt/openssl -DHWLOC_INCLUDE_DIR=hwloc-2.1.0/include -DHWLOC_LIBRARY=hwloc-2.1.0/hwloc/.libs/libhwloc.a
          make -j$(sysctl -n hw.logicalcpu)
          cp src/config.json .
          tar cfz macos_build.tar.gz xmrig config.json
      - name: Upload MacOS build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos_build
          path: macos_build.tar.gz

  build_macos_intel:
    name: Build MacOS (Intel) artifacts
    runs-on: macos-15
    steps:
      - name: Prepare MacOS tools
        run: |
          brew install cmake libuv openssl hwloc
      - name: Checkout code
        uses: actions/checkout@master
      - name: Build hwloc on MacOS
        run: |
          curl -O https://download.open-mpi.org/release/hwloc/v2.1/hwloc-2.1.0.tar.bz2
          tar xjf hwloc-2.1.0.tar.bz2
          cd hwloc-2.1.0
          ./configure --disable-shared --enable-static --disable-io --disable-libxml2
          make -j$(sysctl -n hw.logicalcpu)
          cd ..
      - name: Build project on MacOS
        run: |
          cmake . -DOPENSSL_ROOT_DIR=/usr/local/opt/openssl -DHWLOC_INCLUDE_DIR=hwloc-2.1.0/include -DHWLOC_LIBRARY=hwloc-2.1.0/hwloc/.libs/libhwloc.a
          make -j$(sysctl -n hw.logicalcpu)
          cp src/config.json .
          tar cfz macos_build_intel.tar.gz xmrig config.json
      - name: Upload MacOS build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos_build_intel
          path: macos_build_intel.tar.gz

  deploy:
    needs:
      [
        build_win_msvc,
        build_win_gcc,
        build_linux_x64_static,
        build_linux_x64_ubuntu2404_noble,
        build_linux_x64_ubuntu2204_jammy,
        build_linux_arm64_static,
        build_linux_arm64_ubuntu2404_noble,
        build_linux_arm64_ubuntu2204_jammy,
        build_macos,
        build_macos_intel,
      ]
    name: Create release and upload artifacts
    runs-on: ubuntu-latest
    steps:
      - name: Create Release
        id: create_release
        uses: actions/create-release@v1.0.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ github.ref }}
          draft: false
          prerelease: false
      - name: Set version
        id: version
        run: echo ::set-output name=VERSION::$GITHUB_REF_NAME
      - name: Download Windows MSVC build artifacts
        uses: actions/download-artifact@v4
        with:
          name: windows_build_msvc
      - name: Download Windows GCC build artifacts
        uses: actions/download-artifact@v4
        with:
          name: windows_build_gcc
      - name: Download Linux x64 static build artifacts
        uses: actions/download-artifact@v4
        with:
          name: linux_x64_static
      - name: Download Linux x64 Ubuntu 24.04 noble build artifacts
        uses: actions/download-artifact@v4
        with:
          name: linux_x64_ubuntu24.04_noble
      - name: Download Linux x64 Ubuntu 22.04 jammy build artifacts
        uses: actions/download-artifact@v4
        with:
          name: linux_x64_ubuntu22.04_jammy
      - name: Download Linux ARM64 static build artifacts
        uses: actions/download-artifact@v4
        with:
          name: linux_arm64_static
      - name: Download Linux ARM64 Ubuntu 24.04 noble build artifacts
        uses: actions/download-artifact@v4
        with:
          name: linux_arm64_ubuntu2404_noble
      - name: Download Linux ARM64 Ubuntu 22.04 jammy build artifacts
        uses: actions/download-artifact@v4
        with:
          name: linux_arm64_ubuntu22.04_jammy
      - name: Download macOS build artifacts
        uses: actions/download-artifact@v4
        with:
          name: macos_build
      - name: Download macOS (Intel) build artifacts
        uses: actions/download-artifact@v4
        with:
          name: macos_build_intel

      - name: Upload Windows x64 MSVC release asset
        uses: actions/upload-release-asset@v1.0.1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: windows_build_msvc.zip
          asset_name: xmrig-${{ steps.version.outputs.VERSION }}-Windows-x64-MSVC.zip
          asset_content_type: application/zip
      - name: Upload Windows x64 GCC release asset
        uses: actions/upload-release-asset@v1.0.1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: windows_build_gcc.zip
          asset_name: xmrig-${{ steps.version.outputs.VERSION }}-Windows-x64-GCC.zip
          asset_content_type: application/zip
      - name: Upload Linux x64 static release asset
        uses: actions/upload-release-asset@v1.0.1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: linux_x64_static.tar.gz
          asset_name: xmrig-${{ steps.version.outputs.VERSION }}-Linux-x64-static.tar.gz
          asset_content_type: application/gzip
      - name: Upload Ubuntu 24.04 noble x64 release asset
        uses: actions/upload-release-asset@v1.0.1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: linux_x64_ubuntu24.04_noble.tar.gz
          asset_name: xmrig-${{ steps.version.outputs.VERSION }}-Ubuntu-24.04-noble-x64.tar.gz
          asset_content_type: application/gzip
      - name: Upload Ubuntu 22.04 jammy x64 release asset
        uses: actions/upload-release-asset@v1.0.1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: linux_x64_ubuntu22.04_jammy.tar.gz
          asset_name: xmrig-${{ steps.version.outputs.VERSION }}-Ubuntu-22.04-jammy-x64.tar.gz
          asset_content_type: application/gzip
      - name: Upload Linux ARM64 static release asset
        uses: actions/upload-release-asset@v1.0.1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: linux_arm64_static.tar.gz
          asset_name: xmrig-${{ steps.version.outputs.VERSION }}-Linux-ARM64-static.tar.gz
          asset_content_type: application/gzip
      - name: Upload Ubuntu 24.04 noble ARM64 release asset
        uses: actions/upload-release-asset@v1.0.1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: linux_arm64_ubuntu24.04_noble.tar.gz
          asset_name: xmrig-${{ steps.version.outputs.VERSION }}-Ubuntu-24.04-noble-ARM64.tar.gz
          asset_content_type: application/gzip
      - name: Upload Ubuntu 22.04 jammy ARM64 release asset
        uses: actions/upload-release-asset@v1.0.1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: linux_arm64_ubuntu22.04_jammy.tar.gz
          asset_name: xmrig-${{ steps.version.outputs.VERSION }}-Ubuntu-22.04-jammy-ARM64.tar.gz
          asset_content_type: application/gzip
      - name: Upload macOS ARM64 release asset
        uses: actions/upload-release-asset@v1.0.1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: macos_build.tar.gz
          asset_name: xmrig-${{ steps.version.outputs.VERSION }}-macOS-ARM64.tar.gz
          asset_content_type: application/gzip
      - name: Upload macOS x64 Intel release asset
        uses: actions/upload-release-asset@v1.0.1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: macos_build_intel.tar.gz
          asset_name: xmrig-${{ steps.version.outputs.VERSION }}-macOS-x64-Intel.tar.gz
          asset_content_type: application/gzip

      - name: Update xmrig_setup repo
        run: |
          git clone https://$GITHUB_ACTOR:${{secrets.xmrig_setup_key}}@github.com/NightTTQ/xmrig_setup.git
          cd xmrig_setup
          git config user.name  NightTTQ
          git config user.email ttq@ponder.fun

          # Windows x64 (MSVC = default, GCC = alternative)
          cp ../windows_build_msvc.zip xmrig-Windows-x64-MSVC.zip
          unzip -o ../windows_build_msvc.zip
          zip -u offline_miner_setup.zip xmrig.exe config.json WinRing0x64.sys
          rm -f xmrig.exe config.json WinRing0x64.sys
          cp ../windows_build_gcc.zip xmrig-Windows-x64-GCC.zip

          # Linux: static first (x64, ARM64)
          cp ../linux_x64_static.tar.gz xmrig-Linux-x64-static.tar.gz
          cp ../linux_arm64_static.tar.gz xmrig-Linux-ARM64-static.tar.gz

          # Linux: dynamic by distro (x64)
          cp ../linux_x64_ubuntu24.04_noble.tar.gz xmrig-Ubuntu-24.04-noble-x64.tar.gz
          cp ../linux_x64_ubuntu22.04_jammy.tar.gz xmrig-Ubuntu-22.04-jammy-x64.tar.gz

          # Linux: dynamic by distro (ARM64)
          cp ../linux_arm64_ubuntu24.04_noble.tar.gz xmrig-Ubuntu-24.04-noble-ARM64.tar.gz
          cp ../linux_arm64_ubuntu22.04_jammy.tar.gz xmrig-Ubuntu-22.04-jammy-ARM64.tar.gz

          # macOS
          cp ../macos_build.tar.gz xmrig-macOS-ARM64.tar.gz
          cp ../macos_build_intel.tar.gz xmrig-macOS-x64-Intel.tar.gz

          # Default fallback: Windows = MSVC, Linux = x64 static
          cp xmrig-Windows-x64-MSVC.zip xmrig.zip
          cp xmrig-Linux-x64-static.tar.gz xmrig.tar.gz

          git add xmrig-Windows-x64-MSVC.zip xmrig-Windows-x64-GCC.zip \
            xmrig-Linux-x64-static.tar.gz xmrig-Linux-ARM64-static.tar.gz \
            xmrig-Ubuntu-24.04-noble-x64.tar.gz xmrig-Ubuntu-22.04-jammy-x64.tar.gz \
            xmrig-Ubuntu-24.04-noble-ARM64.tar.gz xmrig-Ubuntu-22.04-jammy-ARM64.tar.gz \
            xmrig-macOS-ARM64.tar.gz xmrig-macOS-x64-Intel.tar.gz \
            xmrig.tar.gz xmrig.zip offline_miner_setup.zip
          git commit -m "xmrig $GITHUB_REF_NAME based release"
          git push
          cd ..
